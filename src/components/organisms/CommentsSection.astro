---
interface Props {
    postId: number;
}

const { postId } = Astro.props;
---

<section class="comments-section" data-post-id={postId}>
    <h2 class="section-title">
        <span class="title-icon">üí¨</span> Comentarios An√≥nimos
    </h2>

    <div class="comments-container">
        <div class="comments-list" id={`comments-list-${postId}`}>
            <div class="loading-state">
                <span class="state-icon">‚è≥</span>
                <span>Cargando comentarios...</span>
            </div>
        </div>

        <div class="comment-form-container">
            <h3 class="form-title">Deja un comentario</h3>
            <p class="form-subtitle">
                Tu identidad ser√° protegida con un nombre animal aleatorio üêæ
            </p>
            <form id={`comment-form-${postId}`} class="comment-form">
                <div class="form-group">
                    <textarea
                        id={`comment-content-${postId}`}
                        name="content"
                        rows="4"
                        placeholder="Escribe tu mensaje aqu√≠..."
                        required
                        maxlength="500"
                        class="comment-input"></textarea>
                    <div class="char-counter">
                        <span id={`char-count-${postId}`}>0</span> / 500
                    </div>
                </div>

                <div class="turnstile-container">
                    <div
                        class="cf-turnstile"
                        data-sitekey={import.meta.env
                            .PUBLIC_TURNSTILE_SITE_KEY ||
                            "1x00000000000000000000AA"}
                        data-theme="light"
                    >
                    </div>
                </div>

                <button
                    type="submit"
                    class="submit-btn"
                    aria-label="Enviar comentario"
                >
                    <span class="btn-text">Publicar Comentario</span>
                    <span class="btn-loader hidden">Cargando...</span>
                </button>
            </form>
            <div id={`comment-error-${postId}`} class="error-message hidden">
            </div>
        </div>
    </div>
</section>

<style>
    .comments-section {
        margin-top: 4rem;
        padding-top: 3rem;
        position: relative;
    }

    .comments-section::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(
            90deg,
            transparent,
            rgba(var(--c-primary-rgb), 0.2),
            transparent
        );
    }

    .section-title {
        font-size: 1.8rem;
        color: var(--c-text);
        margin-bottom: 2rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        letter-spacing: -0.02em;
    }

    .title-icon {
        font-size: 1.8rem;
    }

    .comments-container {
        display: grid;
        grid-template-columns: 1fr;
        gap: 2.5rem;
    }

    @media (min-width: 768px) {
        .comments-container {
            grid-template-columns: 1.5fr 1fr;
            align-items: start;
        }
    }

    .comments-list {
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
        max-height: 650px;
        overflow-y: auto;
        padding-right: 0.75rem;
        padding-bottom: 1rem;
        scroll-behavior: smooth;
    }

    /* Custom Scrollbar for Comments List */
    .comments-list::-webkit-scrollbar {
        width: 6px;
    }
    .comments-list::-webkit-scrollbar-track {
        background: rgba(var(--c-primary-rgb), 0.05);
        border-radius: 10px;
    }
    .comments-list::-webkit-scrollbar-thumb {
        background: rgba(var(--c-primary-rgb), 0.2);
        border-radius: 10px;
        transition: background 0.2s ease;
    }
    .comments-list::-webkit-scrollbar-thumb:hover {
        background: rgba(var(--c-primary-rgb), 0.4);
    }

    .loading-state,
    .empty-state {
        text-align: center;
        padding: 3rem 2rem;
        color: var(--c-secondary);
        background: rgba(255, 255, 255, 0.4);
        border-radius: var(--radius-lg);
        border: 2px dashed rgba(var(--c-primary-rgb), 0.15);
        font-size: 1.05rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
    }

    .state-icon {
        font-size: 2.5rem;
        opacity: 0.7;
    }

    /* Global definition used by JS */
    :global(.comment-item) {
        background: rgba(255, 255, 255, 0.85);
        padding: 1.25rem 1.5rem;
        border-radius: var(--radius-lg);
        border: 1px solid rgba(255, 255, 255, 0.9);
        box-shadow:
            0 4px 20px rgba(0, 0, 0, 0.03),
            inset 0 2px 0 rgba(255, 255, 255, 1);
        backdrop-filter: blur(8px);
        animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        transition:
            transform 0.2s ease,
            box-shadow 0.2s ease;
    }

    :global(.comment-item:hover) {
        transform: translateY(-2px);
        box-shadow:
            0 8px 25px rgba(0, 0, 0, 0.05),
            inset 0 2px 0 rgba(255, 255, 255, 1);
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(15px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    :global(.comment-header) {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid rgba(0, 0, 0, 0.04);
    }

    :global(.comment-author) {
        font-weight: 700;
        color: var(--c-primary-dark);
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 1.05rem;
    }

    :global(.comment-icon) {
        font-size: 1.3rem;
        background: linear-gradient(
            135deg,
            rgba(255, 255, 255, 1),
            rgba(245, 245, 245, 1)
        );
        border-radius: 50%;
        width: 38px;
        height: 38px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.8);
    }

    :global(.comment-date) {
        font-size: 0.8rem;
        color: var(--c-secondary);
        background: rgba(0, 0, 0, 0.03);
        padding: 0.2rem 0.6rem;
        border-radius: var(--radius-full);
        font-weight: 500;
    }

    :global(.comment-content) {
        color: var(--c-text);
        line-height: 1.6;
        font-size: 1rem;
        white-space: pre-wrap;
        word-break: break-word;
    }

    /* Form Styles */
    .comment-form-container {
        padding: 2rem;
        border-radius: var(--radius-xl);
        border: 1px solid rgba(255, 255, 255, 0.6);
        background: linear-gradient(
            145deg,
            rgba(255, 255, 255, 0.7),
            rgba(255, 255, 255, 0.4)
        );
        box-shadow:
            0 15px 35px rgba(0, 0, 0, 0.05),
            inset 0 1px 0 rgba(255, 255, 255, 1);
        backdrop-filter: blur(20px);
        position: sticky;
        top: 7rem;
    }

    .form-title {
        font-size: 1.4rem;
        color: var(--c-text);
        margin-bottom: 0.5rem;
        font-weight: 700;
    }

    .form-subtitle {
        font-size: 0.9rem;
        color: var(--c-secondary);
        margin-bottom: 1.5rem;
        line-height: 1.4;
    }

    .form-group {
        margin-bottom: 1.25rem;
        position: relative;
    }

    .comment-input {
        width: 100%;
        padding: 1rem 1.25rem;
        border-radius: var(--radius-lg);
        border: 2px solid transparent;
        background: rgba(255, 255, 255, 0.9);
        color: var(--c-text);
        font-family: inherit;
        font-size: 1rem;
        line-height: 1.5;
        resize: vertical;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.02) inset;
        transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .comment-input::placeholder {
        color: #a0aec0;
    }

    .comment-input:focus {
        outline: none;
        border-color: var(--c-primary);
        background: white;
        box-shadow:
            0 0 0 4px rgba(var(--c-primary-rgb), 0.1),
            0 4px 15px rgba(0, 0, 0, 0.02);
    }

    .char-counter {
        text-align: right;
        font-size: 0.8rem;
        color: var(--c-secondary);
        margin-top: 0.5rem;
        position: absolute;
        bottom: -1.5rem;
        right: 0.5rem;
    }
    .form-group {
        margin-bottom: 2rem; /* Increased to accommodate counter */
    }

    .load-more-container {
        display: flex;
        justify-content: center;
        margin-top: 1rem;
        padding-bottom: 1rem;
    }

    .load-more-btn {
        padding: 0.6rem 1.2rem;
        border-radius: var(--radius-full);
        background: rgba(var(--c-primary-rgb), 0.1);
        color: var(--c-primary);
        border: 1px solid rgba(var(--c-primary-rgb), 0.2);
        font-weight: 600;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .load-more-btn:hover {
        background: rgba(var(--c-primary-rgb), 0.2);
        transform: translateY(-1px);
    }

    .load-more-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }

    .submit-btn {
        width: 100%;
        padding: 0.85rem 1.5rem;
        border-radius: var(--radius-lg);
        background: linear-gradient(
            135deg,
            var(--c-primary),
            var(--c-accent, var(--c-primary))
        );
        color: white;
        border: none;
        font-weight: 600;
        font-size: 1.05rem;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
        overflow: hidden;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .submit-btn::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
            135deg,
            transparent,
            rgba(255, 255, 255, 0.2),
            transparent
        );
        transform: translateX(-100%);
        transition: transform 0.6s ease;
    }

    .submit-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow:
            0 8px 20px rgba(var(--c-primary-rgb), 0.3),
            0 4px 10px rgba(var(--c-primary-rgb), 0.2);
    }

    .submit-btn:hover:not(:disabled)::after {
        transform: translateX(100%);
    }

    .submit-btn:focus-visible {
        outline: none;
        box-shadow: 0 0 0 4px rgba(var(--c-primary-rgb), 0.3);
    }

    .submit-btn:active:not(:disabled) {
        transform: translateY(1px);
        box-shadow: 0 2px 8px rgba(var(--c-primary-rgb), 0.3);
    }

    .submit-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        background: var(--c-secondary);
        transform: none;
        box-shadow: none;
    }

    .hidden {
        display: none !important;
    }

    .error-message {
        margin-top: 1rem;
        padding: 0.85rem;
        background: rgba(239, 68, 68, 0.1);
        color: rgb(220, 38, 38);
        border-radius: var(--radius-md);
        border: 1px solid rgba(239, 68, 68, 0.2);
        font-size: 0.9rem;
        text-align: center;
        font-weight: 500;
        animation: shake 0.4s ease-in-out;
    }

    @keyframes shake {
        0%,
        100% {
            transform: translateX(0);
        }
        25% {
            transform: translateX(-5px);
        }
        50% {
            transform: translateX(5px);
        }
        75% {
            transform: translateX(-5px);
        }
    }

    .turnstile-container {
        margin-bottom: 1.5rem;
        display: flex;
        justify-content: center;
    }
</style>

<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer
></script>
<script>
    function formatDate(dateString: string) {
        return new Intl.DateTimeFormat("es-CO", {
            dateStyle: "medium",
            timeStyle: "short",
        }).format(new Date(dateString));
    }

    // A mapping of some animals to emojis for fun UI
    const animalEmojis: Record<string, string> = {
        Gato: "üê±",
        Perro: "üê∂",
        Le√≥n: "ü¶Å",
        Tigre: "üêØ",
        Oso: "üêª",
        Lobo: "üê∫",
        Zorro: "ü¶ä",
        Erizo: "ü¶î",
        B√∫ho: "ü¶â",
        √Åguila: "ü¶Ö",
        Delf√≠n: "üê¨",
        Ballena: "üêã",
        Pardo: "üêª",
        Koala: "üê®",
        Panda: "üêº",
        Canguro: "ü¶ò",
        Mapache: "ü¶ù",
        Puma: "üêÜ",
        Jaguar: "üêÜ",
        Lince: "üêà",
    };

    function getAnimalEmoji(name: string) {
        const firstWord = name.split(" ")[0];
        return animalEmojis[firstWord] || "üêæ";
    }

    function escapeHTML(str: string) {
        return str
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    function createCommentElement(comment: any) {
        const emoji = getAnimalEmoji(comment.authorName);
        const safeContent = escapeHTML(comment.content);
        return `
            <div class="comment-item">
                <div class="comment-header">
                    <span class="comment-author">
                        <span class="comment-icon">${emoji}</span>
                        ${comment.authorName}
                    </span>
                    <span class="comment-date">${formatDate(comment.createdAt)}</span>
                </div>
                <div class="comment-content">${safeContent}</div>
            </div>
        `;
    }

    // Initialize comments functionality for each section on the page
    document.querySelectorAll(".comments-section").forEach((section) => {
        const postId = section.getAttribute("data-post-id");
        if (!postId) return;

        const listContainer = document.getElementById(
            `comments-list-${postId}`,
        );
        const form = document.getElementById(
            `comment-form-${postId}`,
        ) as HTMLFormElement;
        const errorContainer = document.getElementById(
            `comment-error-${postId}`,
        );
        const submitBtn = form?.querySelector(
            ".submit-btn",
        ) as HTMLButtonElement;
        const btnText = submitBtn?.querySelector(".btn-text");
        const btnLoader = submitBtn?.querySelector(".btn-loader");

        if (!listContainer || !form) return;

        // Character counter
        const contentInput = document.getElementById(
            `comment-content-${postId}`,
        ) as HTMLTextAreaElement;
        const charCount = document.getElementById(`char-count-${postId}`);

        if (contentInput && charCount) {
            contentInput.addEventListener("input", () => {
                const currentLength = contentInput.value.length;
                charCount.textContent = currentLength.toString();
                if (currentLength >= 500) {
                    charCount.style.color = "rgb(220, 38, 38)"; // Red
                } else {
                    charCount.style.color = ""; // Reset
                }
            });
        }

        let cursor: number | null = null;
        let isLoadingMore = false;

        // Fetch comments
        // Fetch comments
        async function fetchComments(isLoadMore = false) {
            if (isLoadMore) {
                isLoadingMore = true;
                const loadMoreBtn = document.getElementById(
                    `load-more-${postId}`,
                ) as HTMLButtonElement;
                if (loadMoreBtn) loadMoreBtn.disabled = true;
            }

            try {
                let url = `/api/cases/${postId}/comments`;
                if (cursor) {
                    url += `?cursor=${cursor}`;
                }

                const response = await fetch(url);
                if (!response.ok)
                    throw new Error("Network response was not ok");

                const data = await response.json();

                // Remove loading or empty states on first load
                if (!isLoadMore) {
                    listContainer!.innerHTML = "";
                }

                // Remove existing load more button if it exists
                const existingLoadMore = document.querySelector(
                    `.load-more-container[data-post="${postId}"]`,
                );
                if (existingLoadMore) existingLoadMore.remove();

                if (data.comments && data.comments.length > 0) {
                    const commentsHtml = data.comments
                        .map(createCommentElement)
                        .join("");

                    if (isLoadMore) {
                        listContainer!.insertAdjacentHTML(
                            "beforeend",
                            commentsHtml,
                        );
                    } else {
                        listContainer!.innerHTML = commentsHtml;
                    }

                    // Store next cursor
                    cursor = data.nextCursor;

                    // Add load more button if there's a next cursor
                    if (cursor) {
                        const loadMoreHtml = `
                            <div class="load-more-container" data-post="${postId}">
                                <button id="load-more-${postId}" class="load-more-btn">
                                    Cargar m√°s comentarios
                                </button>
                            </div>
                        `;
                        listContainer!.insertAdjacentHTML(
                            "afterend",
                            loadMoreHtml,
                        );

                        // Add event listener to new button
                        setTimeout(() => {
                            const btn = document.getElementById(
                                `load-more-${postId}`,
                            );
                            if (btn) {
                                btn.addEventListener("click", () =>
                                    fetchComments(true),
                                );
                            }
                        }, 0);
                    }
                } else if (
                    !isLoadMore &&
                    (!data.comments || data.comments.length === 0)
                ) {
                    listContainer!.innerHTML =
                        '<div class="empty-state">A√∫n no hay comentarios. ¬°S√© el primero!</div>';
                }
            } catch (error) {
                console.error("Error fetching comments:", error);
                if (!isLoadMore) {
                    listContainer!.innerHTML =
                        '<div class="error-message">Error al cargar los comentarios.</div>';
                }
            } finally {
                isLoadingMore = false;
            }
        }

        // Handle form submission
        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            const content = contentInput.value.trim();

            if (!content) return;

            const formDataData = new FormData(form);
            const cfTurnstileResponse = formDataData.get(
                "cf-turnstile-response",
            );

            // Loading state
            submitBtn.disabled = true;
            btnText?.classList.add("hidden");
            btnLoader?.classList.remove("hidden");
            errorContainer?.classList.add("hidden");

            try {
                const response = await fetch(`/api/cases/${postId}/comments`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ content, cfTurnstileResponse }),
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(
                        data.error || "Error al guardar el comentario",
                    );
                }

                form.reset();

                // Add new comment to UI immediately at the top
                const emptyState = listContainer.querySelector(".empty-state");
                if (emptyState) {
                    listContainer.innerHTML = "";
                }

                listContainer.insertAdjacentHTML(
                    "afterbegin",
                    createCommentElement(data.comment),
                );

                // Reset character count
                if (charCount) {
                    charCount.textContent = "0";
                    charCount.style.color = "";
                }
            } catch (error: any) {
                console.error("Submit error:", error);
                if (errorContainer) {
                    errorContainer.textContent =
                        error.message || "Error de conexi√≥n. Intenta de nuevo.";
                    errorContainer.classList.remove("hidden");
                }
            } finally {
                submitBtn.disabled = false;
                btnText?.classList.remove("hidden");
                btnLoader?.classList.add("hidden");

                // Reset Turnstile widget after submission attempt
                // @ts-ignore
                if (window.turnstile) {
                    // @ts-ignore
                    window.turnstile.reset();
                }
            }
        });

        // Initial fetch
        fetchComments();
    });
</script>
