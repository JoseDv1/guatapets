---
import Layout from "../../layouts/Layout.astro";
import Header from "../../components/organisms/Header.astro";
import { db } from "../../db";
import type { Post } from "../../db/generated/client";

export const prerender = false;

let isAuthenticated = false;
let error = "";

// Check authentication
const sessionCookie = Astro.cookies.get("admin_session");
if (sessionCookie && sessionCookie.value === import.meta.env.ADMIN_PASSWORD) {
    isAuthenticated = true;
}

// Handle login submission
if (Astro.request.method === "POST") {
    const data = await Astro.request.formData();
    const password = data.get("password") as string;

    if (password === import.meta.env.ADMIN_PASSWORD) {
        Astro.cookies.set("admin_session", password, {
            path: "/",
            httpOnly: true,
            secure: import.meta.env.PROD,
            sameSite: "lax",
            maxAge: 60 * 60 * 24 * 7, // 1 week
        });
        return Astro.redirect("/admin");
    } else {
        error = "Contraseña incorrecta";
    }
}

// Handle logout
if (Astro.request.method === "GET" && Astro.url.searchParams.has("logout")) {
    Astro.cookies.delete("admin_session", { path: "/" });
    return Astro.redirect("/admin");
}

let posts: Post[] = [];
if (isAuthenticated) {
    posts = await db.post.findMany({
        orderBy: { createdAt: "desc" },
    });
}
---

<Layout title="Panel de Administración | Guatapets">
    <Header />

    <main class="admin-container">
        {
            isAuthenticated ? (
                <div class="dashboard container">
                    <div class="dashboard-header">
                        <h1>Panel de Administración</h1>
                        <a
                            href="/admin?logout=true"
                            class="btn btn-secondary btn-sm"
                        >
                            Cerrar Sesión
                        </a>
                    </div>

                    <div class="dashboard-content glass">
                        <div class="table-responsive">
                            <table class="admin-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Tipo</th>
                                        <th>Nombre/Especie</th>
                                        <th>Fecha</th>
                                        <th>Raza/Color</th>
                                        <th>Ubicación</th>
                                        <th>Contacto</th>
                                        <th>Publicado</th>
                                        <th>Fecha de publicación</th>
                                        <th>Fecha de modificación</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {posts.map((post) => (
                                        <tr id={`post-row-${post.id}`}>
                                            <td>#{post.id}</td>
                                            <td>
                                                <span
                                                    class={`status-badge badge-${post.type}`}
                                                >
                                                    {post.type}
                                                </span>
                                            </td>
                                            <td>
                                                <strong>
                                                    {post.name || "Sin nombre"}
                                                </strong>
                                                <br />
                                                <span class="text-sm text-secondary">
                                                    {post.species}
                                                </span>
                                            </td>
                                            <td>
                                                {new Date(
                                                    post.createdAt,
                                                ).toLocaleDateString("es-CO", {
                                                    year: "numeric",
                                                    month: "short",
                                                    day: "numeric",
                                                })}
                                            </td>
                                            <td>
                                                {post.breed || "-"}
                                                <br />
                                                <span class="text-sm text-secondary">
                                                    {post.color || "-"}
                                                </span>
                                            </td>
                                            <td>{post.location}</td>
                                            <td>
                                                {post.contactName}
                                                <br />
                                                <span class="text-sm text-secondary">
                                                    {post.contactPhone}
                                                </span>
                                            </td>
                                            <td>
                                                <span
                                                    class={`status-badge ${post.visibility === "public" ? "badge-found" : "badge-lost"}`}
                                                >
                                                    {post.visibility ===
                                                    "public"
                                                        ? "Público"
                                                        : "Oculto"}
                                                </span>
                                            </td>
                                            <td>
                                                {new Date(
                                                    post.createdAt,
                                                ).toLocaleString("es-CO", {
                                                    year: "numeric",
                                                    month: "short",
                                                    day: "numeric",
                                                    hour: "2-digit",
                                                    minute: "2-digit",
                                                })}
                                            </td>
                                            <td>
                                                {new Date(
                                                    post.updatedAt,
                                                ).toLocaleString("es-CO", {
                                                    year: "numeric",
                                                    month: "short",
                                                    day: "numeric",
                                                    hour: "2-digit",
                                                    minute: "2-digit",
                                                })}
                                            </td>
                                            <td>
                                                <span
                                                    class={`status-badge ${post.status === "active" ? "badge-adoption" : "badge-adopted"}`}
                                                >
                                                    {post.status === "active"
                                                        ? "Activo"
                                                        : "Resuelto"}
                                                </span>
                                            </td>
                                            <td class="actions-cell">
                                                <a
                                                    href={`/admin/edit/${post.id}`}
                                                    class="btn-action edit"
                                                >
                                                    <svg
                                                        xmlns="http://www.w3.org/2000/svg"
                                                        width="16"
                                                        height="16"
                                                        viewBox="0 0 24 24"
                                                        fill="none"
                                                        stroke="currentColor"
                                                        stroke-width="2"
                                                        stroke-linecap="round"
                                                        stroke-linejoin="round"
                                                    >
                                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
                                                    </svg>
                                                </a>
                                                <button
                                                    class="btn-action delete"
                                                    data-id={post.id}
                                                    onclick={`deletePost(${post.id})`}
                                                >
                                                    <svg
                                                        xmlns="http://www.w3.org/2000/svg"
                                                        width="16"
                                                        height="16"
                                                        viewBox="0 0 24 24"
                                                        fill="none"
                                                        stroke="currentColor"
                                                        stroke-width="2"
                                                        stroke-linecap="round"
                                                        stroke-linejoin="round"
                                                    >
                                                        <polyline points="3 6 5 6 21 6" />
                                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
                                                        <line
                                                            x1="10"
                                                            y1="11"
                                                            x2="10"
                                                            y2="17"
                                                        />
                                                        <line
                                                            x1="14"
                                                            y1="11"
                                                            x2="14"
                                                            y2="17"
                                                        />
                                                    </svg>
                                                </button>
                                            </td>
                                        </tr>
                                    ))}

                                    {posts.length === 0 && (
                                        <tr>
                                            <td
                                                colspan="12"
                                                class="text-center py-8 text-secondary"
                                            >
                                                No hay casos registrados aún.
                                            </td>
                                        </tr>
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            ) : (
                <div class="login-container container">
                    <div class="login-card glass">
                        <h1 class="text-center mb-6">Acceso Restringido</h1>
                        <p class="text-center text-secondary mb-6">
                            Por favor, introduce la contraseña de administrador
                            para continuar.
                        </p>

                        {error && <div class="error-banner mb-4">{error}</div>}

                        <form method="POST" class="login-form">
                            <div class="form-group mb-6">
                                <label for="password">Contraseña</label>
                                <input
                                    type="password"
                                    id="password"
                                    name="password"
                                    required
                                />
                            </div>

                            <button
                                type="submit"
                                class="btn btn-primary w-full"
                            >
                                Ingresar
                            </button>
                        </form>
                    </div>
                </div>
            )
        }
    </main>
</Layout>

<script is:inline>
    // Expose delete function to global scope
    window.deletePost = async function (id) {
        if (
            !confirm(
                "¿Estás seguro de que deseas eliminar este caso? Esta acción no se puede deshacer.",
            )
        ) {
            return;
        }

        // Optimistic UI - disable button
        const btn = document.querySelector(`.delete[data-id="${id}"]`);
        if (btn) btn.disabled = true;

        try {
            const response = await fetch(`/api/admin/posts/${id}`, {
                method: "DELETE",
            });

            const data = await response.json();

            if (data.success) {
                // Remove row from table
                const row = document.getElementById(`post-row-${id}`);
                if (row) {
                    row.style.opacity = "0";
                    setTimeout(() => row.remove(), 300);
                }
            } else {
                alert(data.message || "Error al eliminar el caso");
                if (btn) btn.disabled = false;
            }
        } catch (error) {
            console.error("Error:", error);
            alert("Error de conexión al intentar eliminar el caso");
            if (btn) btn.disabled = false;
        }
    };
</script>

<style>
    .admin-container {
        padding-top: calc(var(--nav-height) + 2rem);
        padding-bottom: 4rem;
        min-height: 100vh;
        background-color: var(--c-surface-primary);
    }

    /* Login Styles */
    .login-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 60vh;
    }

    .login-card {
        width: 100%;
        max-width: 400px;
        padding: 2.5rem;
        border-radius: var(--radius-lg);
    }

    .login-form input {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid var(--c-surface-secondary);
        border-radius: var(--radius-sm);
        background-color: var(--c-surface-elevated);
        font-size: 1rem;
        color: var(--c-text);
    }

    .error-banner {
        background-color: hsla(358, 70%, 66%, 0.1);
        color: var(--c-accent-alert);
        padding: 0.75rem;
        border-radius: var(--radius-sm);
        text-align: center;
        font-weight: 500;
        border: 1px solid hsla(358, 70%, 66%, 0.3);
    }

    /* Dashboard Styles */
    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }

    .dashboard-content {
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        overflow: hidden;
    }

    .table-responsive {
        overflow-x: auto;
    }

    .admin-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 800px;
    }

    .admin-table th,
    .admin-table td {
        padding: 1rem;
        text-align: left;
        border-bottom: 1px solid var(--c-surface-secondary);
    }

    .admin-table tr {
        transition:
            opacity 0.3s ease,
            background-color 0.2s ease;
    }

    .admin-table tbody tr:hover {
        background-color: var(--c-surface-elevated);
    }

    .admin-table th {
        font-weight: 600;
        color: var(--c-secondary);
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .text-sm {
        font-size: 0.85rem;
    }

    .text-secondary {
        color: var(--c-secondary);
    }

    .mb-4 {
        margin-bottom: 1rem;
    }
    .mb-6 {
        margin-bottom: 1.5rem;
    }
    .w-full {
        width: 100%;
    }
    .text-center {
        text-align: center;
    }
    .py-8 {
        padding-top: 2rem;
        padding-bottom: 2rem;
    }

    /* Status badges */
    .status-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: var(--radius-full);
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: capitalize;
    }

    .badge-lost {
        background-color: hsla(358, 70%, 66%, 0.15);
        color: var(--c-accent-alert);
    }
    .badge-found {
        background-color: hsla(140, 60%, 45%, 0.15);
        color: var(--c-accent-success);
    }
    .badge-adoption {
        background-color: hsla(210, 60%, 55%, 0.15);
        color: #3b82f6;
    }
    .badge-adopted {
        background-color: hsla(45, 90%, 50%, 0.15);
        color: #b45309;
    }

    /* Action buttons */
    .actions-cell {
        display: flex;
        gap: 0.5rem;
    }

    .btn-action {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 2rem;
        height: 2rem;
        border-radius: var(--radius-sm);
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .btn-action.edit {
        background-color: hsla(210, 60%, 55%, 0.1);
        color: #3b82f6;
    }

    .btn-action.edit:hover {
        background-color: #3b82f6;
        color: white;
    }

    .btn-action.delete {
        background-color: hsla(358, 70%, 66%, 0.1);
        color: var(--c-accent-alert);
    }

    .btn-action.delete:hover:not(:disabled) {
        background-color: var(--c-accent-alert);
        color: white;
    }

    .btn-action:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .btn-sm {
        padding: 0.5rem 1rem;
        font-size: 0.85rem;
    }
</style>
