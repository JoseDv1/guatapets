---
import Layout from "../layouts/Layout.astro";
import Header from "../components/organisms/Header.astro";

export const prerender = false;
---

<Layout title="Publicar Caso | Guatapets">
    <Header />
    <main class="page-container">
        <div class="container">
            <div class="form-wrapper glass animate-up">
                <h1 class="form-title">Publicar un Caso</h1>
                <p class="form-desc">
                    Ayúdanos a reunir mascotas con sus familias o a encontrarles
                    un nuevo hogar llenando este formulario.
                </p>

                <!-- Error Banner -->
                <div
                    id="error-banner"
                    class="error-banner"
                    style="display: none;"
                >
                    Ocurrió un error al procesar tu solicitud. Por favor,
                    intenta un poco más tarde.
                </div>

                <form
                    id="post-form"
                    class="report-form"
                    enctype="multipart/form-data"
                >
                    <div class="form-row">
                        <div class="form-group">
                            <label for="type">Tipo de Caso *</label>
                            <select id="type" name="type" required>
                                <option value="">Selecciona...</option>
                                <option value="lost">Mascota Perdida</option>
                                <option value="found">Mascota Encontrada</option
                                >
                                <option value="adopt">Dar en Adopción</option>
                            </select>
                            <span class="error-text" id="error-type"></span>
                        </div>

                        <div class="form-group">
                            <label for="species">Especie *</label>
                            <select id="species" name="species" required>
                                <option value="">Selecciona...</option>
                                <option value="dog">Perro</option>
                                <option value="cat">Gato</option>
                                <option value="bird">Ave</option>
                                <option value="other">Otro</option>
                            </select>
                            <span class="error-text" id="error-species"></span>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="name">Nombre de la Mascota</label>
                            <input
                                type="text"
                                id="name"
                                name="name"
                                placeholder="Ej. Max (Si lo sabes)"
                            />
                        </div>

                        <div class="form-group">
                            <label for="gender">Género</label>
                            <select id="gender" name="gender">
                                <option value="unknown">Desconocido</option>
                                <option value="male">Macho</option>
                                <option value="female">Hembra</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="breed">Raza</label>
                            <input
                                type="text"
                                id="breed"
                                name="breed"
                                placeholder="Ej. Criollo, Labrador..."
                            />
                        </div>

                        <div class="form-group">
                            <label for="color">Color</label>
                            <input
                                type="text"
                                id="color"
                                name="color"
                                placeholder="Ej. Negro con blanco"
                            />
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="location">Ubicación / Sector *</label>
                        <input
                            type="text"
                            id="location"
                            name="location"
                            required
                            placeholder="Ej. Cerca al malecón, Vereda La Piedra..."
                        />
                        <span class="error-text" id="error-location"></span>
                    </div>

                    <div class="form-group">
                        <label for="description">Descripción Detallada *</label>
                        <textarea
                            id="description"
                            name="description"
                            rows="4"
                            required
                            placeholder="Describe cómo es la mascota, si tiene collar, cicatrices, o cómo sucedió..."
                        ></textarea>
                        <span class="error-text" id="error-description"></span>
                    </div>

                    <div class="form-group">
                        <label for="image">Foto de la mascota</label>
                        <input
                            type="file"
                            id="image"
                            name="image"
                            accept="image/*"
                            class="file-input"
                        />
                        <p class="help-text">
                            Una buena foto ayuda muchísimo a reconocer a la
                            mascota. (Máximo 5MB)
                        </p>
                        <span class="error-text" id="error-image"></span>
                    </div>

                    <h3 class="section-divider">Datos de Contacto</h3>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="contactName">Tu Nombre *</label>
                            <input
                                type="text"
                                id="contactName"
                                name="contactName"
                                required
                                placeholder="Ej. Juan Pérez"
                            />
                            <span class="error-text" id="error-contactName"
                            ></span>
                        </div>

                        <div class="form-group">
                            <label for="contactPhone"
                                >Teléfono (WhatsApp ideal) *</label
                            >
                            <input
                                type="tel"
                                id="contactPhone"
                                name="contactPhone"
                                required
                                placeholder="Ej. 300 123 4567"
                            />
                            <span class="error-text" id="error-contactPhone"
                            ></span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="contactEmail"
                            >Correo Electrónico (Opcional)</label
                        >
                        <input
                            type="email"
                            id="contactEmail"
                            name="contactEmail"
                            placeholder="tucorreo@ejemplo.com"
                        />
                        <span class="error-text" id="error-contactEmail"></span>
                    </div>

                    <div class="form-actions">
                        <a href="/" class="btn btn-secondary">Cancelar</a>
                        <button
                            type="submit"
                            id="submit-btn"
                            class="btn btn-primary">Publicar Caso</button
                        >
                    </div>
                </form>
            </div>
        </div>
    </main>
</Layout>

<style>
    .page-container {
        padding-top: calc(var(--nav-height) + 2rem);
        padding-bottom: 4rem;
        min-height: 100vh;
        background-color: var(--c-surface-primary);
    }

    .form-wrapper {
        max-width: 800px;
        margin: 0 auto;
        padding: 2.5rem;
        border-radius: var(--radius-lg);
        box-shadow: 0 10px 30px rgba(44, 26, 17, 0.05);
    }

    .form-title {
        font-size: 2.5rem;
        color: var(--c-text);
        margin-bottom: 0.5rem;
        text-align: center;
    }

    .form-desc {
        color: var(--c-secondary);
        text-align: center;
        margin-bottom: 3rem;
    }

    .report-form {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1.5rem;
    }

    @media (min-width: 768px) {
        .form-row {
            grid-template-columns: 1fr 1fr;
        }
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    label {
        font-weight: 600;
        font-size: 0.95rem;
        color: var(--c-text);
    }

    input[type="text"],
    input[type="tel"],
    input[type="email"],
    select,
    textarea {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid var(--c-surface-secondary);
        border-radius: var(--radius-sm);
        background-color: var(--c-surface-elevated);
        font-family: inherit;
        font-size: 1rem;
        color: var(--c-text);
        transition:
            border-color 0.3s ease,
            box-shadow 0.3s ease;
    }

    input:focus,
    select:focus,
    textarea:focus {
        outline: none;
        border-color: var(--c-primary);
        box-shadow: 0 0 0 3px hsla(21, 48%, 36%, 0.2);
    }

    .section-divider {
        margin-top: 1.5rem;
        margin-bottom: 0.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--c-surface-secondary);
        font-size: 1.5rem;
        color: var(--c-text);
    }

    .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
        margin-top: 2rem;
    }

    .error-text {
        color: var(--c-accent-alert);
        font-size: 0.85rem;
        font-weight: 500;
    }

    .error-banner {
        background-color: hsla(358, 70%, 66%, 0.1);
        color: var(--c-accent-alert);
        padding: 1rem;
        border-radius: var(--radius-sm);
        margin-bottom: 2rem;
        text-align: center;
        font-weight: 500;
        border: 1px solid hsla(358, 70%, 66%, 0.3);
    }

    .animate-up {
        opacity: 0;
        transform: translateY(20px);
    }
    .help-text {
        font-size: 0.85rem;
        color: var(--c-secondary);
        opacity: 0.8;
        margin-top: 0.25rem;
    }

    input[type="file"] {
        padding: 0.5rem;
        background-color: var(--c-surface-elevated);
        border: 1px dashed var(--c-primary);
        cursor: pointer;
    }

    input[type="file"]::file-selector-button {
        background-color: var(--c-surface-secondary);
        border: 1px solid var(--c-secondary);
        border-radius: var(--radius-sm);
        padding: 0.5rem 1rem;
        color: var(--c-text);
        cursor: pointer;
        margin-right: 1rem;
        font-family: inherit;
        font-weight: 500;
        transition: all 0.2s ease;
    }

    input[type="file"]::file-selector-button:hover {
        background-color: var(--c-primary);
        color: var(--c-surface-primary);
    }
</style>

<script>
    import gsap from "gsap";

    // Simple entrance animation
    gsap.to(".animate-up", {
        y: 0,
        opacity: 1,
        duration: 0.6,
        ease: "power3.out",
    });

    const form = document.getElementById("post-form") as HTMLFormElement;
    const errorBanner = document.getElementById("error-banner");
    const submitBtn = document.getElementById(
        "submit-btn",
    ) as HTMLButtonElement;

    if (form) {
        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            // clear errors
            if (errorBanner) errorBanner.style.display = "none";
            document
                .querySelectorAll(".error-text")
                .forEach((el) => (el.textContent = ""));

            const formData = new FormData(form);

            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = "Publicando...";
                submitBtn.style.opacity = "0.7";
                submitBtn.style.cursor = "not-allowed";
            }

            try {
                const res = await fetch("/api/posts", {
                    method: "POST",
                    body: formData,
                });

                const data = await res.json();

                if (data.success) {
                    window.location.href = `/casos/${data.id}`;
                } else if (data.errors) {
                    // validation errors
                    for (const key in data.errors) {
                        const errorEl = document.getElementById(`error-${key}`);
                        if (errorEl) {
                            errorEl.textContent = data.errors[key].join(", ");
                        }
                    }
                } else {
                    if (errorBanner) errorBanner.style.display = "block";
                }
            } catch (err) {
                console.error(err);
                if (errorBanner) errorBanner.style.display = "block";
            } finally {
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = "Publicar Caso";
                    submitBtn.style.opacity = "1";
                    submitBtn.style.cursor = "pointer";
                }
            }
        });
    }
</script>
