---
import Layout from "../layouts/Layout.astro";
import Header from "../components/organisms/Header.astro";
import CaseCard from "../components/molecules/CaseCard.astro";
import { postTypeEnum, speciesEnum, genderEnum } from "../db/schema";
import {
    TYPE_LABELS,
    SPECIES_LABELS,
    GENDER_LABELS,
} from "../constants/filters";

export const prerender = false;
---

<Layout title="Publicar Caso | Guatapets">
    <Header />
    <main class="page-container">
        <div class="container publishing-layout">
            <div class="form-wrapper glass animate-up">
                <h1 class="form-title">Publicar un Caso</h1>
                <p class="form-desc">
                    Ay煤danos a reunir mascotas con sus familias o a encontrarles
                    un nuevo hogar llenando este formulario.
                </p>

                <!-- Error Banner -->
                <div
                    id="error-banner"
                    class="error-banner"
                    style="display: none;"
                >
                    Ocurri贸 un error al procesar tu solicitud. Por favor,
                    intenta un poco m谩s tarde.
                </div>

                <form
                    id="post-form"
                    class="report-form"
                    enctype="multipart/form-data"
                >
                    <div class="form-row">
                        <div class="form-group">
                            <label for="type">Tipo de Caso *</label>
                            <select id="type" name="type" required>
                                <option value="">Selecciona...</option>
                                {
                                    postTypeEnum
                                        .filter((t) => t !== "adopted")
                                        .map((type) => (
                                            <option value={type}>
                                                {TYPE_LABELS[type]}
                                            </option>
                                        ))
                                }
                            </select>
                            <span class="error-text" id="error-type"></span>
                        </div>

                        <div class="form-group">
                            <label for="species">Especie *</label>
                            <select id="species" name="species" required>
                                <option value="">Selecciona...</option>
                                {
                                    speciesEnum.map((species) => (
                                        <option value={species}>
                                            {SPECIES_LABELS[species]}
                                        </option>
                                    ))
                                }
                            </select>
                            <span class="error-text" id="error-species"></span>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="name">Nombre de la Mascota</label>
                            <input
                                type="text"
                                id="name"
                                name="name"
                                placeholder="Ej. Max (Si lo sabes)"
                            />
                        </div>

                        <div class="form-group">
                            <label for="gender">G茅nero</label>
                            <select id="gender" name="gender">
                                <option value="">Selecciona...</option>
                                {
                                    genderEnum.map((gender) => (
                                        <option value={gender}>
                                            {GENDER_LABELS[gender]}
                                        </option>
                                    ))
                                }
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="breed">Raza</label>
                            <input
                                type="text"
                                id="breed"
                                name="breed"
                                placeholder="Ej. Criollo, Labrador..."
                            />
                        </div>

                        <div class="form-group">
                            <label for="color">Color</label>
                            <input
                                type="text"
                                id="color"
                                name="color"
                                placeholder="Ej. Negro con blanco"
                            />
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="location">Ubicaci贸n / Sector *</label>
                        <input
                            type="text"
                            id="location"
                            name="location"
                            required
                            placeholder="Ej. Cerca al malec贸n, Vereda La Piedra..."
                        />
                        <span class="error-text" id="error-location"></span>
                    </div>

                    <div class="form-group">
                        <label for="description">Descripci贸n Detallada *</label>
                        <textarea
                            id="description"
                            name="description"
                            rows="4"
                            required
                            placeholder="Describe c贸mo es la mascota, si tiene collar, cicatrices, o c贸mo sucedi贸..."
                        ></textarea>
                        <span class="error-text" id="error-description"></span>
                    </div>

                    <div class="form-group">
                        <label for="image">Foto de la mascota</label>
                        <input
                            type="file"
                            id="image"
                            name="image"
                            accept="image/*"
                            class="file-input"
                        />
                        <p class="help-text">
                            Una buena foto ayuda much铆simo a reconocer a la
                            mascota. (M谩ximo 5MB)
                        </p>
                        <span class="error-text" id="error-image"></span>
                    </div>

                    <h3 class="section-divider">Datos de Contacto</h3>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="contactName">Tu Nombre *</label>
                            <input
                                type="text"
                                id="contactName"
                                name="contactName"
                                required
                                placeholder="Ej. Juan P茅rez"
                            />
                            <span class="error-text" id="error-contactName"
                            ></span>
                        </div>

                        <div class="form-group">
                            <label for="contactPhone"
                                >Tel茅fono (WhatsApp ideal) *</label
                            >
                            <input
                                type="tel"
                                id="contactPhone"
                                name="contactPhone"
                                required
                                placeholder="Ej. 300 123 4567"
                            />
                            <span class="error-text" id="error-contactPhone"
                            ></span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="contactEmail"
                            >Correo Electr贸nico (Opcional)</label
                        >
                        <input
                            type="email"
                            id="contactEmail"
                            name="contactEmail"
                            placeholder="tucorreo@ejemplo.com"
                        />
                        <span class="error-text" id="error-contactEmail"></span>
                    </div>

                    <div class="form-actions">
                        <a href="/" class="btn btn-secondary">Cancelar</a>
                        <button
                            type="submit"
                            id="submit-btn"
                            class="btn btn-primary">Publicar Caso</button
                        >
                    </div>
                </form>
            </div>

            <!-- Previsualizaci贸n -->
            <aside
                class="preview-wrapper animate-up"
                style="animation-delay: 0.2s"
            >
                <div class="preview-stickybox">
                    <h2 class="preview-title">Vista Previa</h2>
                    <p class="preview-desc">As铆 se ver谩 tu caso publicado.</p>

                    <div id="live-preview-container">
                        <CaseCard
                            petCase={{
                                id: 0,
                                type: "lost",
                                imageUrl: null,
                                name: "Nombre de la Mascota",
                                description:
                                    "Aqu铆 aparecer谩 la descripci贸n detallada...",
                                location: "Ubicaci贸n / Sector",
                            }}
                        />
                    </div>
                </div>
            </aside>
        </div>
    </main>
</Layout>

<style>
    .page-container {
        padding-top: calc(var(--nav-height) + 2rem);
        padding-bottom: 4rem;
        min-height: 100vh;
        background-color: var(--c-surface-primary);
    }
    .publishing-layout {
        display: grid;
        grid-template-columns: 1fr;
        gap: 2rem;
        max-width: 800px;
        margin: 0 auto;
    }

    @media (min-width: 992px) {
        .publishing-layout {
            grid-template-columns: 1fr 400px;
            align-items: start;
            max-width: none;
        }
    }

    .form-wrapper {
        padding: 2.5rem;
        border-radius: var(--radius-lg);
        box-shadow: 0 10px 30px rgba(44, 26, 17, 0.05);
    }

    .preview-wrapper {
        display: block;
        margin-top: 1rem;
        padding: 0 1.5rem; /* added padding for mobile */
    }

    @media (min-width: 992px) {
        .preview-wrapper {
            margin-top: 0;
            padding: 0; /* remove extra padding on desktop */
        }
        .preview-stickybox {
            position: sticky;
            top: calc(var(--nav-height) + 2rem);
        }
    }

    .preview-title {
        font-size: 1.5rem;
        color: var(--c-text);
        margin-bottom: 0.25rem;
    }

    .preview-desc {
        color: var(--c-secondary);
        font-size: 0.9rem;
        margin-bottom: 1.5rem;
    }

    #live-preview-container {
        pointer-events: none; /* Disable clicking on the preview */
    }

    .form-title {
        font-size: 2.5rem;
        color: var(--c-text);
        margin-bottom: 0.5rem;
        text-align: center;
    }

    .form-desc {
        color: var(--c-secondary);
        text-align: center;
        margin-bottom: 3rem;
    }

    .report-form {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1.5rem;
    }

    @media (min-width: 768px) {
        .form-row {
            grid-template-columns: 1fr 1fr;
        }
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    label {
        font-weight: 600;
        font-size: 0.95rem;
        color: var(--c-text);
    }

    input[type="text"],
    input[type="tel"],
    input[type="email"],
    select,
    textarea {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid var(--c-surface-secondary);
        border-radius: var(--radius-sm);
        background-color: var(--c-surface-elevated);
        font-family: inherit;
        font-size: 1rem;
        color: var(--c-text);
        transition:
            border-color 0.3s ease,
            box-shadow 0.3s ease;
    }

    input:focus,
    select:focus,
    textarea:focus {
        outline: none;
        border-color: var(--c-primary);
        box-shadow: 0 0 0 3px hsla(21, 48%, 36%, 0.2);
    }

    .section-divider {
        margin-top: 1.5rem;
        margin-bottom: 0.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--c-surface-secondary);
        font-size: 1.5rem;
        color: var(--c-text);
    }

    .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
        margin-top: 2rem;
    }

    .error-text {
        color: var(--c-accent-alert);
        font-size: 0.85rem;
        font-weight: 500;
    }

    .error-banner {
        background-color: hsla(358, 70%, 66%, 0.1);
        color: var(--c-accent-alert);
        padding: 1rem;
        border-radius: var(--radius-sm);
        margin-bottom: 2rem;
        text-align: center;
        font-weight: 500;
        border: 1px solid hsla(358, 70%, 66%, 0.3);
    }

    .animate-up {
        opacity: 0;
        transform: translateY(20px);
    }
    .help-text {
        font-size: 0.85rem;
        color: var(--c-secondary);
        opacity: 0.8;
        margin-top: 0.25rem;
    }

    input[type="file"] {
        padding: 0.5rem;
        background-color: var(--c-surface-elevated);
        border: 1px dashed var(--c-primary);
        cursor: pointer;
    }

    input[type="file"]::file-selector-button {
        background-color: var(--c-surface-secondary);
        border: 1px solid var(--c-secondary);
        border-radius: var(--radius-sm);
        padding: 0.5rem 1rem;
        color: var(--c-text);
        cursor: pointer;
        margin-right: 1rem;
        font-family: inherit;
        font-weight: 500;
        transition: all 0.2s ease;
    }

    input[type="file"]::file-selector-button:hover {
        background-color: var(--c-primary);
        color: var(--c-surface-primary);
    }
</style>

<script>
    import gsap from "gsap";

    // Simple entrance animation
    gsap.to(".animate-up", {
        y: 0,
        opacity: 1,
        duration: 0.6,
        ease: "power3.out",
    });

    const form = document.getElementById("post-form") as HTMLFormElement;
    const errorBanner = document.getElementById("error-banner");
    const submitBtn = document.getElementById(
        "submit-btn",
    ) as HTMLButtonElement;

    // Preview Elements
    const previewContainer = document.getElementById("live-preview-container");

    // Input Elements
    const typeInput = document.getElementById("type") as HTMLSelectElement;
    const nameInput = document.getElementById("name") as HTMLInputElement;
    const descriptionInput = document.getElementById(
        "description",
    ) as HTMLTextAreaElement;
    const locationInput = document.getElementById(
        "location",
    ) as HTMLInputElement;
    const imageInput = document.getElementById("image") as HTMLInputElement;

    // Update functions
    const updatePreview = () => {
        if (!previewContainer) return;

        // Card root element
        const cardEl = previewContainer.querySelector(
            ".case-card",
        ) as HTMLElement;
        const bgLayer = previewContainer.querySelector(
            ".case-image",
        ) as HTMLElement;
        const badgeEl = previewContainer.querySelector(
            ".case-badge",
        ) as HTMLElement;
        const titleEl = previewContainer.querySelector("h3") as HTMLElement;
        const descEl = previewContainer.querySelector("p") as HTMLElement;
        const locEl = previewContainer.querySelector(
            ".case-meta span",
        ) as HTMLElement;

        if (cardEl && typeInput) {
            // Remove previous type classes
            cardEl.classList.forEach((className) => {
                if (className.startsWith("case-")) {
                    if (
                        className !== "case-card" &&
                        className !== "case-content" &&
                        className !== "case-image" &&
                        className !== "case-meta" &&
                        className !== "case-badge"
                    ) {
                        cardEl.classList.remove(className);
                    }
                }
            });
            // Add new type class
            const currentType = typeInput.value || "lost";
            cardEl.classList.add(`case-${currentType}`);

            if (bgLayer && !bgLayer.classList.contains("has-img")) {
                bgLayer.className = `case-image bg-${currentType}`;
            }

            if (badgeEl) {
                badgeEl.className = `case-badge badge-${currentType}`;
                let badgeText = "Desconocido";
                if (currentType === "lost") badgeText = "Perdido";
                if (currentType === "found") badgeText = "Encontrado";
                if (currentType === "adoption") badgeText = "En Adopci贸n";
                if (currentType === "adopted") badgeText = "Adoptado";
                badgeEl.textContent = badgeText;
            }
        }

        if (titleEl && nameInput) {
            titleEl.textContent = nameInput.value.trim() || "Sin nombre";
        }

        if (descEl && descriptionInput) {
            const descValue =
                descriptionInput.value.trim() ||
                "Aqu铆 aparecer谩 la descripci贸n detallada...";
            descEl.textContent =
                descValue.length > 80
                    ? descValue.substring(0, 80) + "..."
                    : descValue;
        }

        if (locEl && locationInput) {
            locEl.textContent = ` ${locationInput.value.trim() || "Ubicaci贸n / Sector"}`;
        }
    };

    // Attach listeners
    if (form) {
        // Listen to regular inputs
        ["input", "change"].forEach((evt) => {
            form.addEventListener(evt, (e) => {
                const target = e.target as HTMLElement;
                if (target && target.id !== "image") {
                    updatePreview();
                }
            });
        });

        // Specific listener for Image Input (FileReader)
        if (imageInput) {
            imageInput.addEventListener("change", (e) => {
                const target = e.target as HTMLInputElement;
                if (target.files && target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        if (previewContainer && e.target && e.target.result) {
                            const bgLayer = previewContainer.querySelector(
                                ".case-image",
                            ) as HTMLElement;
                            if (bgLayer) {
                                bgLayer.className = "case-image has-img";
                                bgLayer.style.backgroundImage = `url('${e.target.result}')`;
                            }
                        }
                    };
                    reader.readAsDataURL(target.files[0]);
                } else {
                    // Reset image if user cancels selection
                    if (previewContainer) {
                        const bgLayer = previewContainer.querySelector(
                            ".case-image",
                        ) as HTMLElement;
                        const currentType = typeInput.value || "lost";
                        if (bgLayer) {
                            bgLayer.className = `case-image bg-${currentType}`;
                            bgLayer.style.backgroundImage = "none";
                        }
                    }
                }
            });
        }

        // Initial setup
        updatePreview();
    } // <-- Close the attach listeners block

    if (form) {
        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            // clear errors
            if (errorBanner) errorBanner.style.display = "none";
            document
                .querySelectorAll(".error-text")
                .forEach((el) => (el.textContent = ""));

            const formData = new FormData(form);

            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = "Publicando...";
                submitBtn.style.opacity = "0.7";
                submitBtn.style.cursor = "not-allowed";
            }

            try {
                const res = await fetch("/api/posts", {
                    method: "POST",
                    body: formData,
                });

                const data = await res.json();

                if (data.success) {
                    window.location.href = `/casos/${data.id}`;
                } else if (data.errors) {
                    // validation errors
                    for (const key in data.errors) {
                        const errorEl = document.getElementById(`error-${key}`);
                        if (errorEl) {
                            errorEl.textContent = data.errors[key].join(", ");
                        }
                    }
                } else {
                    if (errorBanner) errorBanner.style.display = "block";
                }
            } catch (err) {
                console.error(err);
                if (errorBanner) errorBanner.style.display = "block";
            } finally {
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = "Publicar Caso";
                    submitBtn.style.opacity = "1";
                    submitBtn.style.cursor = "pointer";
                }
            }
        });
    }
</script>
